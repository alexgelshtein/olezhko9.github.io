<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Коллажы</title>

</head>

<body>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let canvas = document.createElement('canvas');
            canvas.setAttribute('id', 'collage');
            canvas.width = 640;
            canvas.height = 480;
            document.body.appendChild(canvas);

            cross = {
                x: Math.round(1 / 3 * canvas.width + Math.random() * 1 / 3 * canvas.width),
                y: Math.round(1 / 3 * canvas.height + Math.random() * 1 / 3 * canvas.height),
            }

            console.log(cross);

            var ctx = canvas.getContext("2d");
            ctx.fillStyle = "red"
            ctx.fillRect(0, 0, cross.x, cross.y);

            ctx.fillStyle = "blue"
            ctx.fillRect(cross.x, 0, canvas.width, cross.y);

            ctx.fillStyle = "green"
            ctx.fillRect(0, cross.y, cross.x, canvas.height);

            ctx.fillStyle = "yellow"
            ctx.fillRect(cross.x, cross.y, canvas.width, canvas.height);

            getQoute()
                .then((quote) => {
                    console.log(quote);
                    quoteLengthPX = ctx.measureText(quote).width;

                    ctx.font = "30px Comic Sans MS";
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';

                    const words = quote.split(' ');
                    let line = "";
                    let lines = [];

                    for (let i = 0; i < words.length; i++) {
                        let testLine = line + words[i] + " ";
                        let testWidth = ctx.measureText(testLine).width;
                        if (testWidth > 4 / 5 * canvas.width) {
                            lines.push(line);
                            line = words[i] + " ";
                        } else {
                            line = testLine;
                        }
                    }
                    lines.push(line);

                    const lineHeight = 30;
                    let marginTop = canvas.height / 2 - lines.length / 2 * lineHeight;
                    for (let i = 0; i < lines.length; i++) {
                        ctx.fillText(lines[i], canvas.width / 2, marginTop);
                        marginTop += lineHeight;
                    }
                })
                .catch((err) => console.error(err));
        });

        let getQoute = function() {
            return new Promise(function(resolve, reject) {
                let xhr = new XMLHttpRequest();
                xhr.open('GET', 'http://fizmatspb.ru/itmoweb/lab3/requester.php', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

                xhr.onreadystatechange = function() {
                    if (this.readyState == 4) {
                        if (xhr.status != 200) {
                            reject(new Error(xhr.status + ': ' + xhr.statusText));
                        } else {
                            resolve(xhr.responseText)
                        }
                    }
                }

                xhr.send();
            });
        }

    </script>
</body>

</html>
